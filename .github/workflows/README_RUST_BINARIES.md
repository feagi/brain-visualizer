# Automated Rust Binary Build Workflow

## Overview

This workflow automatically builds Rust binaries for **all platforms** (Linux, macOS, Windows) whenever Rust code is merged to the `staging` branch, then commits them back to the repository.

## Purpose

**Problem:** Users on different platforms (Windows, Linux, macOS) couldn't run brain-visualizer without first compiling Rust extensions, requiring:
- Rust toolchain installation
- Platform-specific build tools
- 30+ minutes of compilation time
- Technical knowledge of Rust/cargo

**Solution:** This workflow automatically builds platform-specific binaries and commits them to the repo, so users can simply:
```bash
git clone https://github.com/feagi/brain-visualizer.git
cd brain-visualizer/godot_source
# Open in Godot - it just works!
```

## How It Works

### Trigger
The workflow runs when:
- Code is **pushed to `staging` branch**
- Changes affect:
  - `rust_extensions/*/src/**` (Rust source code)
  - `rust_extensions/*/Cargo.toml` (dependencies)
  - `rust_extensions/build.py` (build script)
  - The workflow file itself

### Build Process

```
┌─────────────────────────────────────────────────────────────┐
│  1. Push to staging (Rust code changes)                     │
└────────────────────┬────────────────────────────────────────┘
                     │
        ┌────────────┴────────────┐
        │   Trigger Workflow      │
        └────────────┬────────────┘
                     │
        ┌────────────┴────────────┐
        │   Parallel Builds       │
        │  (3 runners)           │
        └──┬───────┬───────┬──────┘
           │       │       │
    ┌──────▼─┐ ┌──▼──────┐ ┌▼──────────┐
    │ Linux  │ │  macOS  │ │  Windows  │
    │ Runner │ │  Runner │ │  Runner   │
    └──┬─────┘ └──┬──────┘ └┬──────────┘
       │          │          │
       │  Build   │  Build   │  Build
       │  .so     │  .dylib  │  .dll
       │          │  (arm64+ │
       │          │  x86_64) │
       │          │          │
    ┌──▼──────────▼──────────▼──────┐
    │  Upload Artifacts              │
    └──────────┬─────────────────────┘
               │
    ┌──────────▼─────────────────────┐
    │  Download All Artifacts        │
    │  Combine into addon dirs       │
    └──────────┬─────────────────────┘
               │
    ┌──────────▼─────────────────────┐
    │  Commit to staging [skip ci]   │
    └────────────────────────────────┘
```

### Build Matrix

| Platform | Runner | Outputs | Special Features |
|----------|--------|---------|------------------|
| **Linux** | `ubuntu-latest` | `.so` files | Standard x86_64 build |
| **macOS** | `macos-latest` | `.dylib` files | **Universal binary** (arm64 + x86_64) |
| **Windows** | `windows-latest` | `.dll` files | MSVC build |

Each platform builds **two versions**:
- **Debug** (faster compile, larger binary, includes debug symbols)
- **Release** (slower compile, optimized, smaller binary)

Total: **12 binaries** (2 extensions × 2 modes × 3 platforms)

## What Gets Committed

### Directory Structure
```
godot_source/addons/
├── feagi_rust_deserializer/
│   └── target/
│       ├── debug/
│       │   ├── libfeagi_data_deserializer.dylib  (macOS)
│       │   ├── libfeagi_data_deserializer.so     (Linux)
│       │   └── feagi_data_deserializer.dll       (Windows)
│       └── release/
│           ├── libfeagi_data_deserializer.dylib  (macOS)
│           ├── libfeagi_data_deserializer.so     (Linux)
│           └── feagi_data_deserializer.dll       (Windows)
└── feagi_shared_video/
    └── target/
        ├── debug/
        │   ├── libfeagi_shared_video.dylib       (macOS)
        │   ├── libfeagi_shared_video.so          (Linux)
        │   └── feagi_shared_video.dll            (Windows)
        └── release/
            ├── libfeagi_shared_video.dylib       (macOS)
            ├── libfeagi_shared_video.so          (Linux)
            └── feagi_shared_video.dll            (Windows)
```

### Binary Sizes
Typical sizes:
- **macOS** (universal): ~4-6 MB per binary
- **Linux** (x86_64): ~3-4 MB per binary
- **Windows** (x86_64): ~3-4 MB per binary
- **Total**: ~40-50 MB for all binaries

### Commit Message Format
```
chore: Update Rust binaries for all platforms [skip ci]

- Built on Linux: 2025-10-22 14:30:00 UTC
- Built on macOS: 2025-10-22 14:30:00 UTC
- Built on Windows: 2025-10-22 14:30:00 UTC

Includes binaries for:
- feagi_data_deserializer (Linux, macOS, Windows)
- feagi_shared_video (Linux, macOS, Windows)

Auto-generated by GitHub Actions workflow
```

**Note:** `[skip ci]` prevents infinite loops (the commit won't trigger CI again)

## Godot Platform Detection

Godot automatically loads the correct binary based on the platform:

```ini
# feagi_data_deserializer.gdextension
[libraries]
macos.debug = "res://addons/feagi_rust_deserializer/target/debug/libfeagi_data_deserializer.dylib"
macos.release = "res://addons/feagi_rust_deserializer/target/release/libfeagi_data_deserializer.dylib"

linux.debug.x86_64 = "res://addons/feagi_rust_deserializer/target/debug/libfeagi_data_deserializer.so"
linux.release.x86_64 = "res://addons/feagi_rust_deserializer/target/release/libfeagi_data_deserializer.so"

windows.debug.x86_64 = "res://addons/feagi_rust_deserializer/target/debug/feagi_data_deserializer.dll"
windows.release.x86_64 = "res://addons/feagi_rust_deserializer/target/release/feagi_data_deserializer.dll"
```

When Godot starts:
- Detects OS (macOS/Linux/Windows)
- Detects build mode (debug/release)
- Loads the appropriate binary
- **User sees no difference** - it just works!

## Monitoring the Workflow

### View Workflow Runs
1. Go to: `https://github.com/feagi/brain-visualizer/actions`
2. Click on "Build and Commit Rust Binaries" workflow
3. See all runs, their status, and logs

### Check If Binaries Updated
```bash
# Check latest commit on staging
git log staging --oneline -n 5

# Look for commits like:
# abc1234 chore: Update Rust binaries for all platforms [skip ci]
```

### Verify Binary Sizes
```bash
# List all binaries
find godot_source/addons -type f \( -name "*.dylib" -o -name "*.so" -o -name "*.dll" \)

# With sizes
find godot_source/addons -type f \( -name "*.dylib" -o -name "*.so" -o -name "*.dll" \) -exec ls -lh {} \;
```

## Troubleshooting

### Workflow Fails on a Platform

**Symptoms:** One platform (e.g., Windows) fails to build

**Solutions:**
1. Check the workflow logs for the specific platform
2. Look for compilation errors in Rust code
3. Ensure dependencies are available on all platforms
4. Test locally with Docker:
   ```bash
   # For Windows build testing
   docker run --rm -v $(pwd):/work -w /work rust:latest \
     cargo build --target x86_64-pc-windows-gnu
   ```

### Binaries Not Committing

**Symptoms:** Workflow succeeds but no commit appears

**Possible causes:**
- No changes detected (binaries already up to date)
- Check workflow output: "No changes to commit"

**Solutions:**
- Force rebuild by updating a comment in Rust code
- Check git status on the runner (in workflow logs)

### Binary Size Too Large

**Symptoms:** Repo size growing too fast

**Solutions:**
1. Use `strip` to remove debug symbols from release builds:
   ```toml
   # Cargo.toml
   [profile.release]
   strip = true
   ```

2. Enable LTO (Link Time Optimization):
   ```toml
   [profile.release]
   lto = true
   codegen-units = 1
   ```

3. Consider Git LFS for binaries (future option)

### Commit Loop (Infinite Triggering)

**Symptoms:** Workflow keeps triggering itself

**Prevention:** The commit message includes `[skip ci]` to prevent this

**If it happens:**
- Check commit messages
- Ensure `[skip ci]` is in the message
- Temporarily disable workflow
- Fix and re-enable

## Manual Builds

If you need to build locally for testing:

### All Platforms (using existing script)
```bash
cd rust_extensions
python3 build.py  # macOS/Linux
python build.py   # Windows
```

### Specific Platform
```bash
cd rust_extensions/feagi_data_deserializer

# Linux
cargo build --release --target x86_64-unknown-linux-gnu

# macOS Universal
cargo build --release --target aarch64-apple-darwin
cargo build --release --target x86_64-apple-darwin
lipo -create -output libfeagi_data_deserializer.dylib \
  target/aarch64-apple-darwin/release/libfeagi_data_deserializer.dylib \
  target/x86_64-apple-darwin/release/libfeagi_data_deserializer.dylib

# Windows (on Windows or cross-compile)
cargo build --release --target x86_64-pc-windows-msvc
```

## Maintenance

### Adding New Rust Extensions

1. Create the extension in `rust_extensions/your_extension/`
2. Update `rust_extensions/build.py` to include it
3. Create addon directory in `godot_source/addons/your_addon/`
4. Update `.gitignore` to allow its binaries
5. Push to staging - workflow handles the rest!

### Updating Rust Version

The workflow uses `dtolnay/rust-toolchain@stable`, which automatically uses the latest stable Rust.

To pin to a specific version:
```yaml
- name: Install Rust toolchain
  uses: dtolnay/rust-toolchain@stable
  with:
    toolchain: 1.75.0  # Specific version
```

### Disabling Auto-Commit

To build but not commit (for testing):
```yaml
# Comment out the push step
# - name: Commit and push binaries
#   if: steps.git-check.outputs.has_changes == 'true'
#   run: |
#     git push origin staging
```

## Benefits

✅ **Zero setup for users** - Just clone and run  
✅ **Cross-platform support** - Linux, macOS, Windows work out of box  
✅ **Version-locked binaries** - Binary always matches code version  
✅ **Consistent builds** - CI ensures reproducible builds  
✅ **Saves developer time** - No manual "build on 3 platforms" step  
✅ **Reduces onboarding friction** - New users don't need Rust toolchain  
✅ **Offline capable** - No downloads after git clone  
✅ **Aligns with FEAGI principles** - Deterministic, reliable, no fallbacks  

## Performance Impact

- **Workflow runtime**: ~10-15 minutes (parallel builds)
- **Repo size increase**: ~50 MB per commit that changes Rust
- **Git clone time**: +5-10 seconds for binaries
- **User build time saved**: 30+ minutes per platform

**Trade-off:** Slightly larger repo for massively better user experience.

## Related Files

- Workflow: `.github/workflows/build-rust-binaries.yml`
- Gitignore: `.gitignore` (allows addon binaries)
- Build script: `rust_extensions/build.py`
- CI pipeline: `.github/workflows/ci.yml` (tests only)
- Export config: `godot_source/export_presets.cfg` (web excludes natives)

## Questions?

For issues with the workflow:
1. Check Actions tab for specific error
2. Verify Rust code compiles locally first
3. Check binary sizes aren't hitting GitHub limits
4. Review commit history for pattern

---

**Last Updated:** 2025-10-22  
**Maintainer:** FEAGI Development Team

